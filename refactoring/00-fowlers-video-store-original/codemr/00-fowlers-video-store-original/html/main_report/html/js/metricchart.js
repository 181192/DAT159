var model=EQ.namespace("eQ.MetricChart");model.handleMBCheckBox=function(e){e.checked?document.getElementById("metricchart").style.display="inline":document.getElementById("metricchart").style.display="none"},model.updateDots=function(e){for(var t=0;t<e.length;++t)metricValueMap[e[t].name]=+e[t].value;for(t=0;t<metricSpec.length;++t){for(metricSpec[t].level=0;metricValueMap[metricValues[t].name]>metricSpec[t].thresholds[metricSpec[t].level]&&metricSpec[t].level<metricSpec[t].thresholds.length;)metricSpec[t].level++;metricSpec[t].level=metricSpec[t].level-1,5<=metricSpec[t].level&&(metricSpec[t].level=4),metricSpec[t].level<=0&&(metricSpec[t].level=0)}dotContainer.selectAll(".dot").attr("opacity",function(e){return barchartScaleY.domain([e.spec.thresholds[0],e.spec.thresholds[5]]),barchartScaleY(metricValueMap[e.spec.name])>e.posY?.2:1}),valuetextContainer.selectAll(".valuetext").text(function(e){return metricValueMap[e.name]})},model.BARWITHDIV=25,model.chartMargin={top:20,right:20,bottom:20,left:40},model.chartWidth=560-model.chartMargin.left-model.chartMargin.right,model.chartHeight=240-model.chartMargin.top-model.chartMargin.bottom;var xAxisScale=d3.scale.ordinal().rangeRoundPoints([0,model.chartWidth]),barchartScaleX=d3.scale.linear().range([0,model.chartWidth]),barchartScaleY=d3.scale.linear().range([model.chartHeight,0]),levelColor=["#007F24","#62BF18","#FFC800","#FF5B13","#E50000"],levelNames=["Low","Low-medium","Medium-high","High","Very high"],xAxis=d3.svg.axis().scale(xAxisScale).orient("bottom"),yAxis=d3.svg.axis().scale(d3.scale.linear().range([model.chartHeight,0])).orient("left");model.svg=d3.select("#metricchart").append("svg").attr("width",model.chartWidth+model.chartMargin.left+model.chartMargin.right).attr("height",model.chartHeight+model.chartMargin.top+model.chartMargin.bottom).append("g").attr("transform","translate("+model.chartMargin.left+","+model.chartMargin.top+")");var tip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(e){return"<strong>"+e.spec.name+":</strong> <span style='color:red'>"+metricValueMap[e.spec.name]+"<br>("+levelNames[e.spec.level]+")<br></span>"});model.svg.call(tip);for(var metricValueMap={},i=0;i<metricValues.length;++i)metricValueMap[metricValues[i].name]=+metricValues[i].value;var xaxislabels=[""];Array.prototype.push.apply(xaxislabels,metricSpec.map(function(e){return e.shortname})),xaxislabels.push(" "),xAxisScale.domain(xaxislabels),rectWidth=Math.floor(barchartScaleX.range()[1]/model.BARWITHDIV),rectHeight=Math.min(3,Math.floor(barchartScaleY.range()[0]/100)),rectCorner=rectHeight/2,yD=model.chartHeight-rectHeight-rectHeight;var scatData=[];for(i=0;i<metricSpec.length;++i){barchartScaleY.domain([metricSpec[i].thresholds[0],metricSpec[i].thresholds[5]]);var thresholds=[barchartScaleY(metricSpec[i].thresholds[1]),barchartScaleY(metricSpec[i].thresholds[2]),barchartScaleY(metricSpec[i].thresholds[3]),barchartScaleY(metricSpec[i].thresholds[4])];for(metricSpec[i].level=0;metricValueMap[metricValues[i].name]>metricSpec[i].thresholds[metricSpec[i].level]&&metricSpec[i].level<metricSpec[i].thresholds.length;)metricSpec[i].level++;metricSpec[i].level=metricSpec[i].level-1;for(var currentLevel=0;0<yD;){for(;yD<thresholds[currentLevel]&&currentLevel<thresholds.length;)currentLevel++;scatData.push({metricLevel:currentLevel,posY:yD,spec:metricSpec[i]}),yD-=3*rectHeight}yD=model.chartHeight-rectHeight-rectHeight}model.svg.append("rect").attr("x",-model.chartMargin.left).attr("y",-model.chartMargin.top).attr("width","100%").attr("height","100%").attr("rx",5).attr("ry",5).attr("fill","black"),model.svg.append("g").attr("transform","translate("+model.chartMargin.left+","+model.chartMargin.top+")");var valuetextContainer=model.svg.append("g").attr("class","valuetextContainer");valuetextContainer.selectAll(".valuetext").data(metricSpec).enter().append("text").attr("class","valuetext").attr("x",function(e){return xAxisScale(e.shortname)-rectWidth/2}).attr("y",-3).attr("text-anchor","middle").text(function(e){return metricValueMap[e.name]}),model.svg.append("g").attr("class","scatrect").attr("class","x axis").attr("transform","translate(0,"+model.chartHeight+")").call(xAxis).append("text").attr("class","label").attr("x",model.chartWidth).attr("y",-6).style("text-anchor","end").text("Metric"),model.svg.append("g").attr("class","y axis").call(yAxis).append("text").attr("class","label").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Metric Value");var dotContainer=model.svg.append("g").attr("class","dotContainer");dotContainer.selectAll(".dot").data(scatData).enter().append("rect").attr("class","dot").attr("width",rectWidth).attr("height",rectHeight).attr("stroke-width",0).attr("stroke-opacity",1).attr("rx",rectCorner).attr("ry",rectCorner).attr("x",function(e){return xAxisScale(e.spec.shortname)-rectWidth/2}).attr("y",function(e){return e.posY}).attr("opacity",function(e){return barchartScaleY.domain([e.spec.thresholds[0],e.spec.thresholds[5]]),barchartScaleY(metricValueMap[e.spec.name])>e.posY?.2:1}).on("mouseover",tip.show).on("mouseout",tip.hide).style("fill",function(e){return levelColor[e.metricLevel]});var legend=model.svg.selectAll(".legend").data(levelNames).enter().append("g").attr("class","legend").attr("transform",function(e,t){return"translate(0,"+20*(5-t)+")"});legend.append("rect").attr("x",model.chartWidth-18).attr("width",18).attr("height",9).attr("rx",2*rectCorner).attr("ry",2*rectCorner).style("fill",function(e,t){return levelColor[t]}),legend.append("text").attr("x",model.chartWidth-24).attr("y",9).style("text-anchor","end").text(function(e){return e});
